<html lang="en">
    <head>
        <script src="https://cdn.observableusercontent.com/npm/d3@7.6.1/dist/d3.min.js"></script>
        <script src="https://cdn.observableusercontent.com/npm/marked@0.3.12/marked.min.js"></script>
        <script src="https://cdn.observableusercontent.com/npm/htl@0.3.1/dist/htl.min.js"></script>
        <script src="https://cdn.observableusercontent.com/npm/@observablehq/highlight.js@2.0.0/highlight.min.js"></script>

        <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js" integrity="sha256-eTyxS0rkjpLEo16uXTS0uVCS4815lc40K2iVpWDvdSY=" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/smoothness/jquery-ui.css">

        <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
        <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">

        <script src="https://dvmorozov.github.io/arxiv/ArxivNavigator/data/topics.js" charset="utf-8"></script>
        <script src="https://dvmorozov.github.io/arxiv/ArxivNavigator/graphs/force-graph.js" charset="utf-8"></script>

        <link rel="stylesheet" href="https://dvmorozov.github.io/arxiv/ArxivNavigator/graphs/main.css">
        <link rel="shortcut icon" href="https://dvmorozov.github.io/arxiv/ArxivNavigator/graphs/favicon.ico">

        <script language="JavaScript">
            var parentDestination = null;
            //  When page is opened in window graph takes full sizes.
            var graphWidth = $(window).innerWidth();
            var graphHeight = $(window).innerHeight();
            var inFrame = false;

            function isDefined(obj) {
                if (obj !== undefined && obj !== null) return true;
                else return false;
            }

            function updateParentSize() {
                //  Send message with size to parent window.
                if (isDefined(parentDestination)) {
                    window.parent.postMessage({ height: document.body.scrollHeight, width: document.body.scrollWidth },
                        parentDestination);
                }
            }

            function showTopicPopup(topicId) {
                var articleList = [];
                //  Fills list of last articles.
                for (let i = 0; i < topics.nodes.length; i++) {
                    if (topics.nodes[i].id === topicId) {
                        //  Converts data to the form appropriate for DataTables.
                        for (let j = 0; j < topics.nodes[i].last_articles.length; j++) {
                            const article = topics.nodes[i].last_articles[j];
                            const articleLink = '<a href="http://arxiv.org/abs/' + article.id +
                                                '" target="_blank">' + article.title + '</a>';
                            var articleData = [];

                            articleData.push(article.last_version_date);
                            articleData.push(articleLink);
                            //articleData.push(article.id);

                            articleList.push(articleData);
                        }

                        //  Removes all content and creates new table. Otherwise, data is not cleared.
                        $('#popup > #content').children().remove();
                        //  Creates placeholder for table.
                        $('#popup > #content').append('<table>');
                    }
                }

                //  Closes dialog if it was open before,
                //  otherwise content is not displayed.
                if ($("#popup").hasClass("ui-dialog-content") &&
                    $("#popup").dialog("isOpen"))
                    $("#popup").dialog("close");

                var dialog = $("#popup").dialog({
                    title: topicId,
                    resizable: false,
                    //  Height is set up by content.
                    width: 1000,
                    open: function(event, ui) {
                        //  Data table should be created from the event handler,
                        //  otherwise column width aren't set up properly.
                        var table = $('#popup > #content > table').DataTable({
                            data: articleList,
                            columns: [
                                { title: 'Published', "width": "20%" },
                                { title: 'Title' },
                                //{ title: 'Id' },
                            ],
                            info: false,
                            ordering: false,
                            paging: false,
                            searching: false,
                            scrollX: false,
                            scrollY: false,
                            autoWidth: false,
                        });
                    }
                });

                //  Position must be set after opening the dialog.
                dialog.dialog('option', 'position', { my: "center", at: "center", of: window });
            }

            function redrawTopicGraph() {
                var graph = document.getElementById('visualisation');
                //  Removes graph.
                while (graph.hasChildNodes()) {
                    graph.removeChild(graph.firstChild);
                }

                $('svg#visualisation').width(graphWidth);
                $('svg#visualisation').height(graphHeight);

                chart = ForceGraph(topics, {
                    nodeGroup: d => d.group,
                    //nodeStrength: -200,                       //  This could be a number.
                                                                //  Negative value means repulsion, positive - attraction.
                    nodeTitle: d => `${d.id}\n${d.value}`,
                    //linkStroke,                               //  Function or value providing stroke value.
                    //linkStrokeWidth: 2,
                    //nodeRadius: 5,
                    width: graphWidth,
                    height: graphHeight,
                    invalidation: null,                         // a promise to stop the simulation when the cell is re-run
                    graphTitle: "Arxiv.org topics by number of articles (" + topics.article_count + " articles processed)",
                    inFrame: inFrame,
                    showPopup: showTopicPopup
                });

                document.getElementById('visualisation').appendChild(chart);
            }

            (function () {
                var parentEventHandler = function (event) {
                    //  Handles messages from parent window.
                    //	Destination should not be empty string.
                    if (isDefined(event.data) &&
                       (event.data.search("http://") != -1 || event.data.search("https://") != -1)) {
                        parentDestination = event.data;
                        //  When page is opened in frame graph size is decreased.
                        graphWidth = 800;
                        graphHeight = 800;
                        inFrame = true;
                        $('svg#visualisation').width(graphWidth);
                        $('svg#visualisation').height(graphHeight);

                        redrawTopicGraph();
                        updateParentSize();
                    }
                    else
                        parentDestination = null;
                };
                window.addEventListener('message', parentEventHandler, false);
            })();
        </script>
    </head>

    <body>
        <svg id="visualisation"></svg>

        <div id="popup">
            <h3 id="header"></h3>
            <p id="content">
            </p>
        </div>

        <script language="JavaScript">
            redrawTopicGraph();
        </script>
    </body>
</html>